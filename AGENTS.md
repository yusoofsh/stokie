# AGENTS.md

- Stack: TanStack Start (React 19 + Vite) with file-based routing/SSR, TanStack Query, Better Auth, Drizzle ORM on PGlite.
- Paths/types: `@/*` → `src/*`; strict TS; `src/route-tree.ts` is generated by TanStack Router—never edit.
- Root layout: `src/routes/__root.tsx` sets head/meta, wraps `QueryClientProvider`, theme, toasts, and TanStack devtools; router/context built in `src/router.tsx` with SSR query integration.
- Auth: Better Auth config in `src/lib/auth/index.ts` (plugins: admin, organization, multiSession, haveIBeenPwned, tanstack-start cookies); HTTP surface via `/api/auth/$` route; client helpers in `src/lib/auth/client.ts`; Zod schemas in `src/lib/auth/validation.ts`.
- Sessions: reuse `getSession` server fn + `getSessionQuery` (`src/lib/query/auth.ts`) in `beforeLoad` guards to avoid duplicate calls.
- Routing guards: `/auth/$view` redirects signed-in users; `src/routes/dashboard/route.tsx` enforces login (redirects with `search.redirect`); `dashboard/admin/route.tsx` also checks `context.session.user.role === "admin"`.
- Admin flows: `useAdmin` hook wraps Better Auth admin API (create/setRole/ban/unban/revoke/impersonate) with toasts and React Query invalidations; list users via `admin.listUsers` in `dashboard/admin/users.tsx`.
- Data: Drizzle client in `src/lib/db.ts`, schema in `data/schema/auth.ts`, migrations in `data/migrations/`, config in `data/drizzle.config.ts`; PGlite stores data at `./data/postgres`.
- Forms: use TanStack React Form wrapper `useAppForm` + field components in `src/components/tanstack/form.tsx`; see `components/auth/form.tsx` for pattern (validation via Zod, ARIA-friendly fields, submit button states).
- UI: Shadcn-style primitives in `src/components/ui/*`; dashboard layout/nav components under `src/components/dashboard/*` with menu/audit placeholders in `data/placeholder.ts`.
- Styling: Tailwind CSS; prefer `cn` helper for class merging.
- Env: managed via `src/lib/env.ts` (`APP_URL`, `AUTH_SECRET`, optional `VITE_APP_TITLE`; client vars must be `VITE_`-prefixed). `.env` with placeholders exists—fill before running.
- Scripts (bun): `bun dev`, `bun build`, `bun preview`, `bun test` (Vitest), `bun check` (Ultracite format+lint). DB: `bun db:generate`, `bun db:migrate`, `bun db:studio`, `bun db:prepare`.
- Tooling: Ultracite preset (`.github/ultracite.instructions.md`, `.claude/ultracite-standard.md`); Lefthook pre-commit runs `bun check` on staged code.
- Reference-only: `refs/*` (Better T-Stack, design) and `mds/*` RBAC/Convex/Permix docs are legacy/experimental and excluded from TS—don’t treat them as active source unless porting those features.
- Vite config: `vite.config.ts` adds Tailwind plugin and tsconfig paths; keep SSR-safe code in routes/APIs and prefer `createFileRoute` server handlers for new endpoints.
